<!DOCTYPE html>
<html lang="es">
/// Vista para la página de depósito de fondos. Permite a los usuarios añadir saldo ficticio a su cuenta y ver el historial de depósitos realizados.
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>
        <%= title %>
    </title>
    <link rel="icon" type="image/png" href="/images/LogoGPX.png">
    <link rel='stylesheet' href='/stylesheets/style.css' />
    <link rel='stylesheet' href='/stylesheets/dashboard.css' />
    <link rel='stylesheet' href='/stylesheets/deposit.css' />
</head>

<body>
    <video autoplay muted loop class="video-background">
        <source src="/images/FondoPagina.mp4" type="video/mp4">
        Tu navegador no soporta el video de fondo.
    </video>

    <%- include('partials/header') %>

        <div class="page-container">
            <h1 class="page-title">Depositar fondos</h1>

            <p class="page-subtitle">
                Añade saldo ficticio a tu cuenta (proyecto educativo).
            </p>

            <% if (typeof error !=='undefined' && error) { %>
                <div class="alert alert-error">
                    <%= error %>
                </div>
                <% } %>

                    <% if (typeof success !=='undefined' && success) { %>
                        <div class="alert alert-success">
                            <%= success %>
                        </div>
                        <% } %>


                            <div class="card deposit-card">
                                <div class="balance-info">
                                    <div>
                                        <span>Saldo EUR</span>
                                        <strong>
                                            <%= user.balance?.eur?.toFixed(2) || '0.00' %> €
                                        </strong>
                                    </div>
                                    <div>
                                        <span>Saldo BTC</span>
                                        <strong>
                                            <%= user.balance?.btc || 0 %> BTC
                                        </strong>
                                    </div>
                                </div>

                                <form method="POST" action="/deposit" class="deposit-form">
                                    <div class="form-group">
                                        <label>Cantidad</label>
                                        <input type="text" name="amount" placeholder="Ej: 100" required />
                                    </div>

                                    <div class="form-group">
                                        <label>Moneda</label>
                                        <select name="currency">
                                            <!-- € por defecto -->
                                            <option value="eur">EUR</option>

                                            <!-- Otras monedas disponibles en el sistema -->
                                            <% if (typeof coins !== 'undefined' && coins && coins.length) { %>
                                                <% coins.forEach(function(coin) { 
                                                    const symbol = String(coin.symbol || '').toLowerCase();
                                                    if (symbol === 'eur') return;
                                                %>
                                                    <option value="<%= symbol %>">
                                                        <%= coin.symbol %> - <%= coin.name %>
                                                    </option>
                                                <% }); %>
                                            <% } %>
                                        </select>
                                    </div>

                                    <div class="form-group">
                                        <label>Origen (IBAN / Wallet)</label>
                                        <input type="text" name="destination" placeholder="Ej: ES12 3456... / bc1q..." required />
                                        <div class="help-text">No se valida como un banco.</div>
                                    </div>

                                    <button type="submit" class="btn btn-primary full-width">
                                        Depositar
                                    </button>
                                </form>
                            </div>

                            <div class="card" style="margin-top: 18px;">
                                <h2 style="margin: 0 0 14px 0;">Historial de depósitos</h2>

                                <% if (!history || history.length===0) { %>
                                    <p style="color:#9a9a9a; margin:0;">Aún no hay depósitos registrados.</p>
                                    <% } else { %>
                                        <div style="overflow-x:auto;">
                                            <table class="history-table">
                                                <thead>
                                                    <tr>
                                                        <th>Fecha</th>
                                                        <th>Cantidad</th>
                                                        <th>Comisión</th>
                                                        <th>Moneda</th>
                                                        <th>Origen</th>
                                                        <th>Estado</th>
                                                    </tr>
                                                </thead>
                                                <tbody>
                                                    <% history.forEach(function(tx) { %>
                                                        <tr>
                                                            <td>
                                                                <% const d = new Date(tx.createdAt);
                                                                   const fmtDate = d.toLocaleDateString('es-ES');
                                                                   const fmtTime = d.toLocaleTimeString('es-ES', { hour: '2-digit', minute: '2-digit' });
                                                                %>
                                                                <%= fmtDate %>,<br/><%= fmtTime %>
                                                            </td>
                                                            <td><%= Number(tx.amount).toFixed(2) %></td>
                                                            <td><%= Number(tx.fee).toFixed(2) %></td>
                                                            <td><%= String(tx.currency).toUpperCase() %></td>
                                                            <td><%= tx.destination.substring(0, 20) %>...</td>
                                                            <td>
                                                                <span style="color: #4CAF50; font-weight: 500;">
                                                                    <%= tx.status === 'completed' ? 'Completado' : 'Pendiente' %>
                                                                </span>
                                                            </td>
                                                        </tr>
                                                    <% }); %>
                                                </tbody>
                                            </table>
                                        </div>
                                    <% } %>
                            </div>
        </div>


        <%- include('partials/footer') %>

</body>

</html>